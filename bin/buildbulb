#!/usr/bin/env ruby

require 'logger'
require 'thor'

$LOAD_PATH << File.join(File.dirname(__FILE__), "..", "lib")

require 'build-bulb'

class BuildBulbCLI < Thor

    option :verbose, :type => :boolean, :default => false
    option :light, :type => :string, :default => 'BBEBB'
    option :address, :type => :string, :default => '0.0.0.0'
    option :port, :type => :numeric, :default => 4712
    option :projects, :type => :string, :default => 'projects.json'
    option :test, :type => :boolean, :default => false
    desc "start", "Listen for status changes of projects and change the color of the light."
    def start()

        logger = Logger.new(STDERR)
        logger.level = options[:verbose] ? Logger::DEBUG : Logger::INFO

        light = BuildBulb::FakeLight.new(logger, options[:light])
        if !options[:test]
            light = BuildBulb::Light.get(options[:light])
        end
        
        marshaller = BuildBulb::ProjectsFileMarshaller.new(logger, options[:projects])
        projects = BuildBulb::Projects.new(logger, marshaller)

        server = BuildBulb::Server.new(logger, options[:address], options[:port], projects, light)
        server.listen_indefinitely()
    end

end

BuildBulbCLI.start(ARGV)
