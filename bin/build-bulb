#!/usr/bin/env ruby

require 'json'
require 'logger'
require 'socket'
$LOAD_PATH << File.join(File.dirname(__FILE__), "..", "lib")

require 'build-bulb'

DEBUG = true
PORT = 0
NAME = 1
PROJECTS = 2

# address:port for receiving updates
address = "0.0.0.0"
port = ARGV[PORT] ? ARGV[PORT] : 4712
LOGGER.debug("port is #{port}")

# name of the light to control
light_label = ARGV[NAME] ? ARGV[NAME] : "BBEBB"
light = BuildBulb::Light.get_light(light_label, debug: DEBUG)
LOGGER.debug("light is #{light}")

projects_file_name = ARGV[PROJECTS] ? ARGV[PROJECTS] : "projects.json"
marshaller = BuildBulb::ProjectsFileMarshaller.new(projects_file_name, LOGGER)
projects = BuildBulb::Projects.new(projects=marshaller.load, marshaller=marshaller)

server = BuildBulb::Server.new(address, port, projects, light, LOGGER)
server.listen_indefinitely()
